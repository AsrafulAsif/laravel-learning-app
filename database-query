CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL
);



CREATE TABLE roles(

    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    role_name VARCHAR(255) NOT NULL UNIQUE,

    role_display_name VARCHAR(255) NOT NULL,

    role_description TEXT,

    is_active TINYINT(1) NOT NULL DEFAULT 1,

    is_deleted TINYINT(1) NOT NULL DEFAULT 0,

    created_by VARCHAR(255),

    updated_by VARCHAR(255),

    deleted_by VARCHAR(255),

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    updated_at TIMESTAMP NULL,

    deleted_at TIMESTAMP NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



CREATE TABLE permissions (

    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    permission_name VARCHAR(255) NOT NULL UNIQUE,

    permission_display_name VARCHAR(255) NOT NULL,

    permission_description TEXT NULL,

    controller_name VARCHAR(255) NOT  NULL,

    api_url VARCHAR(255) NOT  NULL,

    method_name VARCHAR(255) NOT  NULL,

    is_active TINYINT(1) DEFAULT 1,

    is_deleted TINYINT(1) DEFAULT 0,

    created_by VARCHAR(255),

    updated_by VARCHAR(255),

    deleted_by VARCHAR(255),

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    updated_at DATETIME NULL,

    deleted_at DATETIME NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



CREATE TABLE role_permissions (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    role_id BIGINT UNSIGNED NOT NULL,

    permission_id BIGINT UNSIGNED NOT NULL,

    is_active TINYINT(1) DEFAULT 1,

    is_deleted TINYINT(1) DEFAULT 0,

    created_by VARCHAR(255),

    updated_by VARCHAR(255),

    deleted_by VARCHAR(255),

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    updated_at DATETIME NULL,

    deleted_at DATETIME NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



CREATE TABLE user_roles (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,

    user_id BIGINT UNSIGNED NOT NULL,

    role_id BIGINT UNSIGNED NOT NULL,

    is_active TINYINT(1) DEFAULT 1,

    is_deleted TINYINT(1) DEFAULT 0,

    created_by VARCHAR(255),

    updated_by VARCHAR(255),

    deleted_by VARCHAR(255),

    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    updated_at DATETIME NULL,

    deleted_at DATETIME NULL

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



CREATE TABLE personal_access_tokens (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    tokenable_type VARCHAR(255) NOT NULL,
    tokenable_id BIGINT UNSIGNED NOT NULL,
    name TEXT NOT NULL,
    token VARCHAR(64) NOT NULL UNIQUE,
    abilities TEXT NULL,
    last_used_at TIMESTAMP NULL DEFAULT NULL,
    expires_at TIMESTAMP NULL DEFAULT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX personal_access_tokens_expires_at_index (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;



SELECT
    controller_name,
    JSON_ARRAYAGG(
        JSON_OBJECT(
            'id', id,
            'permission_name', permission_name,
            'permission_display_name', permission_display_name,
            'permission_description', permission_description,
            'controller_name', controller_name,
            'api_url', api_url,
            'method_name', method_name,
            'is_active', is_active,
            'is_deleted', is_deleted,
            'created_by', created_by,
            'updated_by', updated_by,
            'deleted_by', deleted_by,
            'created_at', created_at,
            'updated_at', updated_at,
            'deleted_at', deleted_at
        )
    ) AS permissions
FROM permissions
WHERE is_deleted = 0
GROUP BY controller_name
ORDER BY controller_name;




SELECT *
FROM permissions
WHERE is_deleted = 0
ORDER BY controller_name, id;



SELECT EXISTS (
    SELECT 1
    FROM users u
    INNER JOIN user_roles ur ON u.id = ur.user_id AND ur.is_active = 1 AND ur.is_deleted = 0
    INNER JOIN roles r ON r.id = ur.role_id AND r.is_deleted = 0 AND r.is_active = 1
    INNER JOIN role_permissions rp ON rp.role_id = r.id AND rp.is_deleted = 0 AND rp.is_active = 1
    INNER JOIN permissions p ON p.id = rp.permission_id AND p.is_deleted = 0 AND p.is_active = 1
    WHERE u.id = 2
      AND p.method_name = 'POST'
      AND 'api/permission/create' REGEXP CONCAT('^', REPLACE(p.api_url, '{', '[^/]+'), '$')
) AS has_permission;




